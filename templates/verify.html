<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verify OTP</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===== General Styles ===== */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
body {
    display: flex; justify-content: center; align-items: center;
    height: 100vh; margin: 0;
    background: linear-gradient(135deg, #00bcd4, #00796b);
    overflow: hidden; position: relative;
}

/* Floating Circles */
.circle { position: absolute; border-radius: 50%; opacity: 0.15; animation: float 10s infinite ease-in-out alternate; }
.circle1 { width: 200px; height: 200px; top: -50px; left: -50px; background: #fff; }
.circle2 { width: 300px; height: 300px; bottom: -100px; right: -80px; background: #000; animation-duration: 12s; }

/* Container */
.container {
    background: #fff; padding: 30px 40px; border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    text-align: center; width: 380px; max-width: 95%;
    animation: fadeInScale 0.6s ease;
}

/* Title */
.container h2 { color: #00796b; margin-bottom: 20px; font-size: 1.8rem; }

/* Input */
input {
    width: 100%; padding: 12px 15px; margin: 10px 0;
    border-radius: 25px; border: 2px solid #ddd; font-size: 1rem;
    transition: 0.3s;
}
input:focus { border-color: #00bcd4; box-shadow: 0 0 6px rgba(0,188,212,0.3); }
input.error-field { border-color: red; box-shadow: 0 0 5px red; }

/* Buttons */
button {
    width: 100%; padding: 12px; margin-top: 10px;
    border: none; border-radius: 25px; cursor: pointer;
    font-weight: bold; font-size: 1rem; color: #fff;
    background: linear-gradient(45deg, #00bcd4, #00796b);
    transition: transform 0.1s, opacity 0.3s;
}
button:hover { opacity: 0.9; transform: translateY(-2px); }
button:active { transform: scale(0.97); }
button:disabled { background: #80deea; cursor: not-allowed; }
button.go-back { background: #f44336; }

/* Flash Messages */
.flash {
    margin-bottom: 10px; padding: 10px 15px;
    border-radius: 10px; font-weight: bold; opacity: 0;
    transition: opacity 0.5s ease-in-out; text-align: center;
}
.flash.show { opacity: 1; }
.flash-success { background: #4CAF50; color: #fff; }
.flash-danger { background: #f44336; color: #fff; }
.flash-info { background: #2196F3; color: #fff; }

/* Change Email link */
.change-email {
    margin-top: 12px; display: block; font-size: 0.9rem;
    color: #00796b; cursor: pointer; text-decoration: underline;
}
.change-email:hover { color: #00bcd4; }

/* Modal */
.modal {
    display: none; position: fixed; z-index: 1000;
    left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
}
.modal-content {
    background: #fff; padding: 20px 30px; border-radius: 15px;
    width: 90%; max-width: 400px; text-align: center;
    animation: fadeInScale 0.5s ease;
    position: relative;
}
.modal-content h3 { margin-bottom: 15px; color: #00796b; }
.modal-content input {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd;
    margin-bottom: 15px;
}
.modal-close {
    position: absolute; top: 10px; right: 15px;
    font-size: 1.3rem; cursor: pointer; color: #888;
}
.modal-close:hover { color: #000; }

/* Animations */
@keyframes float {
    0% { transform: translateY(0); }
    100% { transform: translateY(-20px); }
}
@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

/* Responsive */
@media(max-width: 400px){
    .container { padding: 20px; }
    input, button { font-size: 0.9rem; }
}
</style>
</head>
<body>

<!-- Floating Circles -->
<div class="circle circle1"></div>
<div class="circle circle2"></div>

<div class="container">
    <h2>Enter OTP</h2>

    <!-- Flash messages -->
    <div id="flash-container"></div>

    <!-- OTP Form -->
    <form id="otpForm" action="{{ url_for('verify_otp') }}" method="POST">
        <input type="text" name="otp" placeholder="Enter OTP" id="otpInput" autocomplete="one-time-code" inputmode="numeric">
        <button type="submit" id="verifyBtn">Verify OTP</button>
    </form>

    <!-- Go Back Button -->
    <button type="button" id="goBackBtn" class="go-back">Go Back</button>

    <!-- Resend OTP -->
    <button id="resendOtpBtn" type="button">Resend OTP</button>

    <!-- Change Email -->
    <span class="change-email" id="changeEmailBtn">Change Email</span>
</div>

<!-- Modal -->
<div class="modal" id="changeEmailModal">
    <div class="modal-content">
        <span class="modal-close" id="modalClose">&times;</span>
        <h3>Change Email</h3>
        <input type="email" id="newEmail" placeholder="Enter new email">
        <button id="updateEmailBtn">Update Email</button>
    </div>
</div>

<script>
/* ===== OTP Page JS ===== */

// Auto-focus OTP input
document.getElementById('otpInput').focus();

// Flash messages
function showFlash(message, category='info', duration=2000) {
    const flashDiv = document.createElement('div');
    flashDiv.classList.add('flash', `flash-${category}`);
    flashDiv.textContent = message;
    document.getElementById('flash-container').prepend(flashDiv);

    setTimeout(() => flashDiv.classList.add('show'), 10);
    setTimeout(() => {
        flashDiv.classList.remove('show');
        setTimeout(() => flashDiv.remove(), 500);
    }, duration);
}

// OTP validation
document.getElementById('otpForm').addEventListener('submit', function(e){
    e.preventDefault();
    const otp = document.getElementById('otpInput').value;

    fetch('{{ url_for("verify_otp") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ otp })
    })
    .then(res => res.json())
    .then(data => {
        showFlash(data.msg, data.ok ? 'success' : 'danger');
        if(data.ok){
            setTimeout(()=> window.location.href = "/login", 1500);
        }
    })
    .catch(() => showFlash("OTP verification failed!", 'danger'));
});

// Resend OTP
document.getElementById('resendOtpBtn').addEventListener('click', function(){
    const btn = this;
    btn.disabled = true; btn.textContent = 'Sending...';

    fetch('{{ url_for("resend_otp") }}', {
        method: 'POST', credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
        showFlash(data.msg || 'OTP sent to your email.', data.ok ? 'success' : 'danger');
        btn.disabled = false; btn.textContent = 'Resend OTP';
        document.getElementById('otpInput').focus();
    })
    .catch(() => {
        showFlash('Failed to resend OTP.', 'danger');
        btn.disabled = false; btn.textContent = 'Resend OTP';
    });
});

// Modal open/close
const modal = document.getElementById('changeEmailModal');
document.getElementById('changeEmailBtn').addEventListener('click', () => modal.style.display = 'flex');
document.getElementById('modalClose').addEventListener('click', () => modal.style.display = 'none');
window.addEventListener('click', e => { if(e.target === modal) modal.style.display = 'none'; });

// Update Email
document.getElementById('updateEmailBtn').addEventListener('click', function(){
    const btn = this;
    btn.disabled = true; btn.textContent = 'Updating...';
    const newEmail = document.getElementById('newEmail').value.trim();
    if(!newEmail){
        showFlash('Please enter a valid email.', 'danger');
        btn.disabled = false; btn.textContent = 'Update Email';
        return;
    }
    fetch('{{ url_for("change_otp_email") }}', {
        method: 'POST', credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: newEmail})
    })
    .then(res => res.json())
    .then(data => {
        showFlash(data.msg || 'Email updated!', data.ok ? 'success' : 'danger');
        modal.style.display = 'none';
        btn.disabled = false; btn.textContent = 'Update Email';
    })
    .catch(() => {
        showFlash('Failed to update email.', 'danger');
        btn.disabled = false; btn.textContent = 'Update Email';
    });
});

// Go Back button
document.getElementById('goBackBtn').addEventListener('click', () => window.history.back());
</script>
</body>
</html>
